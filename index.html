<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tile Home Clone - Fases</title>
    
    <!-- Google AdSense/AdMob SDK - Substituir com seu pr√≥prio ID -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX"
     crossorigin="anonymous"></script>
     
    <!-- Fonte estilo cartoon -->
    <link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Fredoka+One&display=swap" rel="stylesheet">
     
    <style>
        /* --- ESTILO GERAL --- */
        body {
            margin: 0;
            background: linear-gradient(to bottom, #20bf55, #01baef); /* Gradiente Verde/Azul vibrante */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        .game-layout {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 800px;
            flex: 1;
            padding: 0 20px;
        }

        /* --- HUD SUPERIOR --- */
        .header {
            width: 100%;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            z-index: 10;
            position: relative;
        }
        
        .level-badge {
            background: rgba(0,0,0,0.3);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .coins-container {
            display: flex;
            align-items: center;
            gap: 10px;
            position: absolute;
            right: 20px;
            top: 20px;
        }

        .coins {
            background: white;
            padding: 8px 20px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .add-coins-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            border: 3px solid white;
            color: white;
            font-size: 1.8rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }

        .add-coins-btn:hover {
            transform: scale(1.1);
        }

        .add-coins-btn:active {
            transform: scale(0.95);
        }

        /* --- TABULEIRO (√Årea do Jogo) --- */
        #game-container {
            flex: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            margin-bottom: 25px;
        }

        #game-board {
            position: relative;
            width: 380px;
            height: 420px;
            display: flex;
            justify-content: center;
            align-items: center;
            /* border: 1px dashed rgba(255,255,255,0.3); Debug area */
        }

        /* --- PE√áAS (TILES) --- */
        .tile {
            width: 60px;
            height: 66px;
            background-color: #fdfdfd;
            border-radius: 10px;
            /* Sombra complexa para dar efeito 3D estilo Mahjong */
            box-shadow: 
                inset 0 -4px 0 #dcdcdc, 
                0 4px 0 #bbb, 
                0 6px 6px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px; /* Emoji maior */
            position: absolute;
            cursor: pointer;
            transition: all 0.1s ease-out;
            z-index: 1;
            border: 2px solid #ddd;
        }

        .tile.blocked {
            cursor: not-allowed;
        }

        /* Efeito ao clicar */
        .tile:active {
            transform: translateY(4px);
            box-shadow: inset 0 -2px 0 #ccc, 0 0 0 #bbb;
        }

        /* Anima√ß√£o de shake para pe√ßas bloqueadas */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* --- BANDEJA (TRAY) --- */
        .tray-container {
            background: #fbe4c2; /* Madeira clara */
            width: auto; /* Ajusta ao conte√∫do */
            height: 90px;
            border-radius: 15px;
            border-bottom: 6px solid #8d6e63;
            border-left: 2px solid #8d6e63;
            border-right: 2px solid #8d6e63;
            margin: 20px auto 25px auto;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            position: relative;
            padding: 0 15px 10px 15px; /* Padding lateral menor */
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .tray-slots {
            display: flex;
            gap: 6px;
        }
        
        .slot {
            width: 50px;
            height: 56px;
            background-color: rgba(0,0,0,0.05);
            border-radius: 8px;
            border: 1px dashed rgba(141, 110, 99, 0.4);
        }

        /* --- SKILLS --- */
        .skills-bar {
            display: flex;
            gap: 30px;
            margin: 0 auto 25px auto;
            justify-content: center;
            max-width: 500px;
        }

        .skill-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: #fff;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 0 #ccc, 0 5px 10px rgba(0,0,0,0.1);
            position: relative;
            transition: transform 0.1s;
        }
        
        .skill-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #ccc;
        }

        .lock-icon {
            position: absolute;
            bottom: -2px;
            right: -2px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            padding: 4px;
            font-size: 12px;
            width: 15px;
            height: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .skill-counter {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #2ecc71;
            color: white;
            border-radius: 50%;
            padding: 4px;
            font-size: 14px;
            font-weight: bold;
            min-width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* --- POPUPS --- */
        #overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }
        
        .modal-box {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            width: 80%;
            max-width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes slideDown {
            0% { transform: translateY(-100px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        @keyframes slideUp {
            0% { transform: translateY(100px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(600px) rotate(720deg); opacity: 0; }
        }

        /* Victory Screen */
        .victory-screen {
            position: relative;
            padding: 20px;
        }

        .victory-banner {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            animation: slideDown 0.5s ease;
        }

        .victory-title {
            color: white;
            font-size: 1.2rem;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .victory-level {
            color: white;
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0 0 0;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
        }

        .coin-reward {
            background: white;
            padding: 30px;
            border-radius: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: bounceIn 0.6s ease 0.3s backwards;
        }

        .coin-icon {
            font-size: 5rem;
        }

        .coin-amount {
            font-size: 2rem;
            color: #f39c12;
            font-weight: bold;
            margin: 10px 0;
        }

        .next-level-box {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3), 0 0 20px rgba(46,204,113,0.5);
            animation: slideUp 0.5s ease 0.6s backwards, pulse 0.8s ease 1.2s infinite;
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        .next-level-box:hover {
            transform: scale(1.05);
        }
        
        .next-level-box:active {
            transform: scale(0.95);
        }

        .next-level-text {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .confetti-piece {
            position: fixed;
            width: 10px;
            height: 10px;
            top: -10px;
            animation: confetti 3s linear infinite;
        }

        h1 { color: #333; margin: 0 0 10px 0; }
        p { color: #666; font-size: 1.1rem; }

        /* --- HOME SCREEN --- */
        #home-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, #20bf55, #01baef);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            overflow: hidden;
        }



        .home-logo {
            background: linear-gradient(180deg, #00D4FF 0%, #00B8E6 100%);
            padding: 35px 50px;
            border-radius: 25px;
            margin-bottom: 100px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            border: none;
            position: relative;
            z-index: 2;
            text-align: center;
        }

        .home-title {
            font-family: 'Fredoka One', 'Lilita One', cursive;
            font-size: 5rem;
            font-weight: 900;
            margin: 0;
            letter-spacing: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            line-height: 1;
        }

        .home-title-number {
            font-family: 'Fredoka One', cursive;
            font-size: 9rem;
            color: white;
            text-shadow: 
                0 0 20px rgba(255,255,255,0.8),
                4px 4px 0 rgba(0,0,0,0.2);
            font-weight: 900;
            line-height: 0.8;
        }

        .home-title-tiles {
            font-family: 'Fredoka One', cursive;
            font-size: 5rem;
            color: #ffa500;
            text-shadow: 
                3px 3px 0 #ff8c00,
                -2px -2px 0 #ffb84d,
                5px 5px 10px rgba(0,0,0,0.3);
            font-weight: 900;
            letter-spacing: 5px;
        }

        .home-subtitle {
            font-family: 'Fredoka One', cursive;
            font-size: 1.5rem;
            color: white;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            margin: 15px 0 0 0;
            font-weight: 900;
            letter-spacing: 2px;
            opacity: 0.9;
        }

        .home-button {
            background: linear-gradient(to bottom, #ffa500, #ff8c00);
            color: white;
            font-size: 2rem;
            font-weight: bold;
            padding: 20px 80px;
            border: 5px solid white;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3), inset 0 -5px 0 rgba(0,0,0,0.2);
            transition: transform 0.1s;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 2;
        }

        .home-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.4), inset 0 -5px 0 rgba(0,0,0,0.2);
        }

        .home-button:active {
            transform: translateY(2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.3), inset 0 -2px 0 rgba(0,0,0,0.2);
        }

        .current-level-display {
            color: white;
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 2;
        }

        /* Bot√µes de Navega√ß√£o */
        .nav-buttons {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            z-index: 15;
        }

        .nav-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.1s;
            z-index: 20;
            position: relative;
        }

        .nav-btn:hover {
            transform: scale(1.1);
        }

        .nav-btn:active {
            transform: scale(0.95);
        }

        /* Config Modal */
        .config-modal {
            background: linear-gradient(135deg, #3498db, #2980b9);
            padding: 0;
            border-radius: 30px;
            width: 85%;
            max-width: 350px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        .config-header {
            background: linear-gradient(135deg, #5dade2, #3498db);
            padding: 25px;
            position: relative;
        }

        .config-title {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .config-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(0,0,0,0.2);
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.2s;
        }

        .config-close:hover {
            background: rgba(0,0,0,0.4);
        }

        .config-content {
            background: white;
            padding: 25px;
        }

        .config-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 2px solid #ecf0f1;
        }

        .config-option:last-of-type {
            border-bottom: none;
        }

        .config-label {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .config-icon {
            font-size: 2rem;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 70px;
            height: 35px;
            background: #27ae60;
            border-radius: 35px;
            cursor: pointer;
            transition: background 0.3s;
            border: 3px solid #ecf0f1;
        }

        .toggle-switch.off {
            background: #bdc3c7;
        }

        .toggle-knob {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 27px;
            height: 27px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .toggle-switch:not(.off) .toggle-knob {
            transform: translateX(35px);
        }

        .toggle-check {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .config-extras {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #ecf0f1;
            display: flex;
            justify-content: space-around;
        }

        .config-extra-btn {
            font-size: 2.5rem;
            background: none;
            border: none;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .config-extra-btn:hover {
            transform: scale(1.2);
        }

        .config-footer {
            text-align: center;
            padding: 15px;
            color: #95a5a6;
            font-size: 0.9rem;
        }

        /* Shop Modal */
        .shop-modal {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            padding: 0;
            border-radius: 30px;
            width: 90%;
            max-width: 380px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5);
            overflow: hidden;
            max-height: 80vh;
            overflow-y: auto;
        }

        .shop-header {
            background: linear-gradient(135deg, #a569bd, #9b59b6);
            padding: 25px;
            position: relative;
        }

        .shop-title {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .shop-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(0,0,0,0.2);
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.2s;
        }

        .shop-close:hover {
            background: rgba(0,0,0,0.4);
        }

        .shop-content {
            background: white;
            padding: 25px 15px;
        }

        .shop-section {
            margin-bottom: 25px;
        }

        .shop-section-title {
            color: #2c3e50;
            font-size: 1.3rem;
            font-weight: bold;
            margin: 0 0 15px 0;
            padding-left: 10px;
            border-left: 4px solid #9b59b6;
        }

        .shop-items {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .shop-item {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }

        .shop-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .shop-item-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .shop-item-icon {
            font-size: 3rem;
        }

        .shop-item-details {
            display: flex;
            flex-direction: column;
        }

        .shop-item-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 0;
        }

        .shop-item-desc {
            font-size: 0.9rem;
            color: #333;
            margin: 3px 0 0 0;
        }

        .shop-item-price {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .shop-price-btn {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 20px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }

        .shop-price-btn:hover {
            transform: scale(1.05);
        }

        .shop-price-btn:active {
            transform: scale(0.95);
        }

        .shop-price-btn.ad-option {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .coin-package {
            background: linear-gradient(135deg, #ffd93d, #ffa500);
            border: 3px solid #f39c12;
        }

        .coin-package .shop-item-name {
            color: white;
        }

        .coin-package .shop-price-btn {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        /* Language Modal */
        .language-modal {
            background: white;
            border-radius: 30px;
            width: 85%;
            max-width: 400px;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5);
        }

        .language-header {
            background: linear-gradient(135deg, #5dade2, #3498db);
            padding: 20px;
            position: relative;
            border-radius: 30px 30px 0 0;
        }

        .language-title {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .language-close {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(231,76,60,1);
            border: 3px solid white;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }

        .language-close:hover {
            transform: scale(1.1);
        }

        .language-close:active {
            transform: scale(0.95);
        }

        .language-content {
            padding: 30px 20px;
        }

        .language-option {
            background: #f8f9fa;
            padding: 18px 25px;
            margin-bottom: 15px;
            border-radius: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #5a6c7d;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .language-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        .language-option.selected {
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            color: #2d3436;
            box-shadow: 0 4px 15px rgba(253,203,110,0.4);
        }

        .language-checkmark {
            font-size: 2rem;
            color: #27ae60;
            display: none;
        }

        .language-option.selected .language-checkmark {
            display: block;
        }

        .language-confirm {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(39,174,96,0.3);
            transition: transform 0.1s;
        }

        .language-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(39,174,96,0.4);
        }

        .language-confirm:active {
            transform: translateY(0);
        }

        .level-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 18px;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.2s;
            min-width: 60px;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .level-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(52,152,219,0.4);
        }

        .level-btn:active {
            transform: translateY(0);
        }

        .level-btn.completed {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .level-btn.locked {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-primary {
            margin-top: 20px;
            padding: 15px 40px;
            font-size: 1.2rem;
            background: linear-gradient(to bottom, #2ecc71, #27ae60);
            border: none;
            border-radius: 50px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #1e8449;
            width: 100%;
        }
        
        .btn-primary:active { transform: translateY(4px); box-shadow: none; }

        .btn-danger {
            margin-top: 20px;
            padding: 15px 40px;
            font-size: 1.2rem;
            background: linear-gradient(to bottom, #e74c3c, #c0392b);
            border: none;
            border-radius: 50px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #962d22;
            width: 100%;
        }
        .btn-danger:active { transform: translateY(4px); box-shadow: none; }

        /* --- CONTADOR CIRCULAR --- */
        .countdown-circle {
            width: 150px;
            height: 150px;
            margin: 20px auto;
            position: relative;
        }

        .countdown-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            font-weight: bold;
            color: #333;
        }

        .countdown-ring {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 8px solid #e0e0e0;
            border-top: 8px solid #00bfff;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn-continue {
            margin-top: 20px;
            padding: 15px 40px;
            font-size: 1.2rem;
            background: linear-gradient(to bottom, #00d084, #00a368);
            border: none;
            border-radius: 50px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #007d4d;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-continue:active { transform: translateY(4px); box-shadow: none; }

        /* --- BANNER AD CONTAINER --- */
        .banner-ad-container {
            width: 100%;
            max-width: 320px;
            height: 50px;
            margin: 10px auto;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

    </style>
</head>
<body>

    <!-- M√öSICA DE FUNDO -->
    <audio id="background-music" loop>
        <source src="background-music.mp3" type="audio/wav">
    </audio>

    <!-- SOM DE CLIQUE -->
    <audio id="click-sound">
        <source src="click-sound.wav" type="audio/wav">
    </audio>

    <!-- SOM DE VIT√ìRIA -->
    <audio id="victory-sound">
        <source src="victory-sound.wav" type="audio/wav">
    </audio>

    <!-- SOM DE FRUTA SELECIONADA -->
    <audio id="fruit-select-sound">
        <source src="fruit-select.mp3" type="audio/mpeg">
    </audio>

    <!-- HOME SCREEN -->
    <div id="home-screen">
        <!-- Moedas no topo da Home -->
        <div style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div class="coins">‚≠ê <span id="home-coin-display">300</span></div>
                <button class="add-coins-btn" onclick="openShop()">+</button>
            </div>
        </div>
        
        <div class="home-logo" id="home-logo">
            <p class="home-title">
                <span class="home-title-number">7</span>
                <span class="home-title-tiles">TILES</span>
            </p>
            <p class="home-subtitle">JOGO DE COMBINAR</p>
        </div>
        
        <p class="current-level-display" id="home-level-display">N√≠vel 1</p>
        
        <button class="home-button" onclick="startGame()">N√≠vel 1</button>
        
        <button class="home-button" onclick="openLevelSelector()" style="margin-top: 15px; background: linear-gradient(135deg, #9b59b6, #8e44ad); font-size: 1.2rem;">
            üìã Selecionar N√≠vel
        </button>
        
        <button class="nav-btn" onclick="openConfig()" style="position: absolute; top: 20px; right: 20px; z-index: 10;">
            ‚öôÔ∏è
        </button>
    </div>

    <!-- NAVIGATION BUTTONS (Game Screen) -->
    <div class="nav-buttons" style="display: none;" id="nav-buttons">
        <button class="nav-btn" onclick="goHome()">‚Ü©Ô∏è</button>
        <button class="nav-btn" onclick="openConfig()">‚öôÔ∏è</button>
    </div>

    <div class="header">
        <div class="level-badge" id="level-display">N√≠vel 1</div>
        <div class="coins-container">
            <div class="coins">‚≠ê <span id="coin-display">300</span></div>
            <button class="add-coins-btn" onclick="openShop()">+</button>
        </div>
    </div>

    <!-- BANDEJA NO TOPO -->
    <div class="tray-container">
        <div class="tray-slots" id="tray-display">
            <div class="slot"></div><div class="slot"></div><div class="slot"></div>
            <div class="slot"></div><div class="slot"></div><div class="slot"></div>
            <div class="slot"></div>
        </div>
    </div>

    <!-- TABULEIRO NO CENTRO -->
    <div id="game-container">
        <div id="game-board">
            <!-- Tiles via JS -->
        </div>
    </div>

    <!-- SKILLS NA PARTE INFERIOR -->
    <div class="skills-bar">
        <button class="skill-btn" id="undo-btn" onclick="useSkill('undo')">
            ‚Ü©Ô∏è
            <div class="lock-icon" id="undo-lock">üîí</div>
            <div class="skill-counter" id="undo-counter" style="display:none;">0</div>
        </button>
        <button class="skill-btn" id="shuffle-btn" onclick="useSkill('shuffle')">
            üîÄ
            <div class="lock-icon" id="shuffle-lock">üîí</div>
            <div class="skill-counter" id="shuffle-counter" style="display:none;">0</div>
        </button>
        <button class="skill-btn" id="hint-btn" onclick="useSkill('hint')">
            üí°
            <div class="lock-icon" id="hint-lock">üîí</div>
            <div class="skill-counter" id="hint-counter" style="display:none;">0</div>
        </button>
    </div>

    <!-- BANNER AD (Bottom of Screen) -->
    <div class="banner-ad-container">
        <!-- Google AdSense Banner - Substituir com seu c√≥digo -->
        <ins class="adsbygoogle"
             style="display:inline-block;width:320px;height:50px"
             data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
             data-ad-slot="XXXXXXXXXX"></ins>
    </div>

    <!-- OVERLAY (Modals) -->
    <div id="overlay">
        <div class="modal-box" id="modal-content">
            <!-- Conte√∫do din√¢mico -->
        </div>
    </div>

    <!-- CONFIG MODAL -->
    <div id="config-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 250; backdrop-filter: blur(5px);">
        <div class="config-modal">
            <div class="config-header">
                <h2 class="config-title">Configura√ß√£o</h2>
                <button class="config-close" onclick="closeConfig()">‚úñ</button>
            </div>
            <div class="config-content">
                <div class="config-option">
                    <div class="config-label">
                        <span class="config-icon">üéµ</span>
                        <span>M√∫sica</span>
                    </div>
                    <div class="toggle-switch" id="music-toggle" onclick="toggleMusic()">
                        <div class="toggle-knob"></div>
                        <span class="toggle-check">‚úì</span>
                    </div>
                </div>
                
                <div class="config-option">
                    <div class="config-label">
                        <span class="config-icon">üîä</span>
                        <span>Som</span>
                    </div>
                    <div class="toggle-switch" id="sound-toggle" onclick="toggleSound()">
                        <div class="toggle-knob"></div>
                        <span class="toggle-check">‚úì</span>
                    </div>
                </div>
                
                <div class="config-option">
                    <div class="config-label">
                        <span class="config-icon">üîî</span>
                        <span>Notifica√ß√£o</span>
                    </div>
                    <div class="toggle-switch" id="notification-toggle" onclick="toggleNotification()">
                        <div class="toggle-knob"></div>
                        <span class="toggle-check">‚úì</span>
                    </div>
                </div>
                
                <button onclick="openLanguageModal()" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; padding: 15px; border: none; border-radius: 15px; font-size: 1.3rem; font-weight: bold; width: 100%; margin-top: 20px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
                    üåê Idioma / Language
                </button>
            </div>
            <div class="config-footer">
                Vers√£o: <span id="game-version">1.0.0</span>
            </div>
        </div>
    </div>

    <!-- LANGUAGE MODAL -->
    <div id="language-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 300; backdrop-filter: blur(5px);">
        <div class="language-modal">
            <div class="language-header">
                <h2 class="language-title">L√≠ngua</h2>
                <button class="language-close" onclick="closeLanguageModal()">‚úñ</button>
            </div>
            <div class="language-content">
                <div class="language-option" id="lang-option-pt" onclick="selectLanguage('pt')">
                    <span>Portugu√™s</span>
                    <span class="language-checkmark">‚úî</span>
                </div>
                <div class="language-option" id="lang-option-en" onclick="selectLanguage('en')">
                    <span>English</span>
                    <span class="language-checkmark">‚úî</span>
                </div>
                <div class="language-option" id="lang-option-es" onclick="selectLanguage('es')">
                    <span>Espa√±ol</span>
                    <span class="language-checkmark">‚úî</span>
                </div>
                <button class="language-confirm" onclick="confirmLanguage()">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- LEVEL SELECTOR MODAL -->
    <div id="level-selector-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 300; backdrop-filter: blur(5px);">
        <div class="language-modal" style="max-height: 80vh; overflow-y: auto;">
            <div class="language-header">
                <h2 class="language-title">üìã Selecionar N√≠vel</h2>
                <button class="language-close" onclick="closeLevelSelector()">‚úñ</button>
            </div>
            <div class="language-content" style="max-height: 60vh; overflow-y: auto;">
                <div id="level-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 10px;">
                    <!-- N√≠veis ser√£o gerados dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- SHOP MODAL -->
    <div id="shop-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 250; backdrop-filter: blur(5px);">
        <div class="shop-modal">
            <div class="shop-header">
                <h2 class="shop-title">üõí Loja</h2>
                <button class="shop-close" onclick="closeShop()">‚úñ</button>
            </div>
            <div class="shop-content">
                <!-- Moedas -->
                <div class="shop-section">
                    <h3 class="shop-section-title">üí∞ Moedas</h3>
                    <div class="shop-items">
                        <div class="shop-item coin-package">
                            <div class="shop-item-info">
                                <div class="shop-item-icon">üí∞</div>
                                <div class="shop-item-details">
                                    <p class="shop-item-name">100 Moedas</p>
                                    <p class="shop-item-desc">Pacote pequeno</p>
                                </div>
                            </div>
                            <div class="shop-item-price">
                                <button class="shop-price-btn" onclick="buyCoins(100, 0.99)">R$ 0,99</button>
                            </div>
                        </div>
                        
                        <div class="shop-item coin-package">
                            <div class="shop-item-info">
                                <div class="shop-item-icon">üíé</div>
                                <div class="shop-item-details">
                                    <p class="shop-item-name">500 Moedas</p>
                                    <p class="shop-item-desc">Pacote m√©dio</p>
                                </div>
                            </div>
                            <div class="shop-item-price">
                                <button class="shop-price-btn" onclick="buyCoins(500, 3.99)">R$ 3,99</button>
                            </div>
                        </div>
                        
                        <div class="shop-item coin-package">
                            <div class="shop-item-info">
                                <div class="shop-item-icon">üíé</div>
                                <div class="shop-item-details">
                                    <p class="shop-item-name">1500 Moedas</p>
                                    <p class="shop-item-desc">Pacote grande</p>
                                </div>
                            </div>
                            <div class="shop-item-price">
                                <button class="shop-price-btn" onclick="buyCoins(1500, 9.99)">R$ 9,99</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Habilidades -->
                <div class="shop-section">
                    <h3 class="shop-section-title">‚ö° Habilidades</h3>
                    <div class="shop-items">
                        <div class="shop-item">
                            <div class="shop-item-info">
                                <div class="shop-item-icon">‚Ü©Ô∏è</div>
                                <div class="shop-item-details">
                                    <p class="shop-item-name">Desfazer (Undo)</p>
                                    <p class="shop-item-desc">Volta 1 movimento</p>
                                </div>
                            </div>
                            <div class="shop-item-price">
                                <button class="shop-price-btn" onclick="buySkillWithCoins('undo')">
                                    ‚≠ê 50
                                </button>
                                <button class="shop-price-btn ad-option" onclick="buySkillWithAd('undo')">
                                    üì∫ Assistir
                                </button>
                            </div>
                        </div>
                        
                        <div class="shop-item">
                            <div class="shop-item-info">
                                <div class="shop-item-icon">üîÄ</div>
                                <div class="shop-item-details">
                                    <p class="shop-item-name">Embaralhar</p>
                                    <p class="shop-item-desc">Reorganiza as pe√ßas</p>
                                </div>
                            </div>
                            <div class="shop-item-price">
                                <button class="shop-price-btn" onclick="buySkillWithCoins('shuffle')">
                                    ‚≠ê 100
                                </button>
                                <button class="shop-price-btn ad-option" onclick="buySkillWithAd('shuffle')">
                                    üì∫ Assistir
                                </button>
                            </div>
                        </div>
                        
                        <div class="shop-item">
                            <div class="shop-item-info">
                                <div class="shop-item-icon">üí°</div>
                                <div class="shop-item-details">
                                    <p class="shop-item-name">Dica (Hint)</p>
                                    <p class="shop-item-desc">Mostra pr√≥xima jogada</p>
                                </div>
                            </div>
                            <div class="shop-item-price">
                                <button class="shop-price-btn" onclick="buySkillWithCoins('hint')">
                                    ‚≠ê 150
                                </button>
                                <button class="shop-price-btn ad-option" onclick="buySkillWithAd('hint')">
                                    üì∫ Assistir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ïES ---
        const TRAY_CAPACITY = 7;
        
        // Categorias de tiles para progress√£o de dificuldade
        const TILE_CATEGORIES = {
            fruits: ['üçé', 'üçå', 'üçá', 'üçâ', 'üçä', 'üçì', 'üçç', 'ü•ù', 'üçí', 'üçë', 'üçã', 'üçê', 'ü•≠', 'üçà', 'ü´ê', 'ü••'],
            flowers: ['üå∏', 'üå∫', 'üåº', 'üåª', 'üå∑', 'üåπ', 'üèµÔ∏è', 'üíê', 'ü•Ä', 'ü™∑', 'üåµ', 'üçÑ'],
            animals: ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üêî'],
            objects: ['‚öΩ', 'üéæ', 'üé±', 'üéØ', 'üé≤', 'üß∏', 'üéÆ', 'üé™', 'üé®', 'üé≠', 'üé∫', 'üé∏', 'üîî', 'üîë', 'üî®', '‚öôÔ∏è', 'üîß', 'ü™õ', 'üß§', 'ü•õ', '‚òï', 'üçµ']
        };
        
        const ALL_TILE_TYPES = [
            ...TILE_CATEGORIES.fruits,
            ...TILE_CATEGORIES.flowers,
            ...TILE_CATEGORIES.animals,
            ...TILE_CATEGORIES.objects
        ];
        
        // Vers√£o do jogo (atualizar a cada nova vers√£o)
        const GAME_VERSION = '1.0.0';
        
        let currentLevel = 1;
        let coins = 300;
        
        let tilesOnBoard = [];
        let tilesInTray = [];
        let isProcessing = false; // Trava clique durante anima√ß√µes
        
        // Sistema de Game Over com propaganda
        let countdownTimer = null;
        let countdownSeconds = 5;
        let gameOverState = null; // Guarda estado antes do game over
        
        // Sistema de Skills - Agora com contadores de uso
        let skillUses = {
            undo: 0,      // Quantas vezes tem dispon√≠vel
            shuffle: 0,   // Quantas vezes tem dispon√≠vel
            hint: 0       // Quantas vezes tem dispon√≠vel
        };
        
        const SKILL_PRICES = {
            undo: 50,      // Pre√ßo em moedas por uso
            shuffle: 100,  // Pre√ßo em moedas por uso
            hint: 150      // Pre√ßo em moedas por uso
        };

        // Configura√ß√µes (toggles)
        let settings = {
            music: true,
            sound: true,
            notification: true
        };

        // Sistema de Idiomas
        let currentLanguage = 'pt';
        
        const translations = {
            pt: {
                level: 'N√≠vel',
                shop: 'üõí Loja',
                coins: 'Moedas',
                skills: 'Habilidades',
                undo: 'Desfazer (Undo)',
                undoDesc: 'Volta 1 movimento',
                shuffle: 'Embaralhar',
                shuffleDesc: 'Reorganiza as pe√ßas',
                hint: 'Dica (Hint)',
                hintDesc: 'Mostra pr√≥xima jogada',
                watch: 'Assistir',
                smallPack: 'Pacote pequeno',
                mediumPack: 'Pacote m√©dio',
                largePack: 'Pacote grande',
                victory: 'VIT√ìRIA!',
                levelComplete: 'N√≠vel Completo',
                reward: 'Recompensa',
                nextLevel: 'Pr√≥ximo N√≠vel',
                gameOver: 'GAME OVER!',
                tryAgain: 'Tente Novamente',
                watchAd: 'Ver An√∫ncio',
                continueGame: 'Continuar',
                restart: 'Reiniciar',
                noMoves: 'SEM JOGADAS!',
                noMovesDesc: 'N√£o h√° movimentos poss√≠veis',
                config: 'Configura√ß√£o',
                music: 'M√∫sica',
                sound: 'Som',
                notification: 'Notifica√ß√£o',
                version: 'Vers√£o'
            },
            en: {
                level: 'Level',
                shop: 'üõí Shop',
                coins: 'Coins',
                skills: 'Skills',
                undo: 'Undo',
                undoDesc: 'Go back 1 move',
                shuffle: 'Shuffle',
                shuffleDesc: 'Reorganize tiles',
                hint: 'Hint',
                hintDesc: 'Show next move',
                watch: 'Watch',
                smallPack: 'Small pack',
                mediumPack: 'Medium pack',
                largePack: 'Large pack',
                victory: 'VICTORY!',
                levelComplete: 'Level Complete',
                reward: 'Reward',
                nextLevel: 'Next Level',
                gameOver: 'GAME OVER!',
                tryAgain: 'Try Again',
                watchAd: 'Watch Ad',
                continueGame: 'Continue',
                restart: 'Restart',
                noMoves: 'NO MOVES!',
                noMovesDesc: 'No possible moves',
                config: 'Settings',
                music: 'Music',
                sound: 'Sound',
                notification: 'Notification',
                version: 'Version'
            },
            es: {
                level: 'Nivel',
                shop: 'üõí Tienda',
                coins: 'Monedas',
                skills: 'Habilidades',
                undo: 'Deshacer',
                undoDesc: 'Retrocede 1 movimiento',
                shuffle: 'Mezclar',
                shuffleDesc: 'Reorganiza las piezas',
                hint: 'Pista',
                hintDesc: 'Muestra siguiente jugada',
                watch: 'Ver',
                smallPack: 'Paquete peque√±o',
                mediumPack: 'Paquete mediano',
                largePack: 'Paquete grande',
                victory: '¬°VICTORIA!',
                levelComplete: 'Nivel Completo',
                reward: 'Recompensa',
                nextLevel: 'Siguiente Nivel',
                gameOver: '¬°GAME OVER!',
                tryAgain: 'Intentar de Nuevo',
                watchAd: 'Ver Anuncio',
                continueGame: 'Continuar',
                restart: 'Reiniciar',
                noMoves: '¬°SIN JUGADAS!',
                noMovesDesc: 'No hay movimientos posibles',
                config: 'Configuraci√≥n',
                music: 'M√∫sica',
                sound: 'Sonido',
                notification: 'Notificaci√≥n',
                version: 'Versi√≥n'
            }
        };
        
        function t(key) {
            return translations[currentLanguage][key] || key;
        }

        // --- NAVEGA√á√ÉO ---
        function startGame() {
            playClickSound();
            document.getElementById('home-screen').style.display = 'none';
            document.getElementById('nav-buttons').style.display = 'flex';
            startLevel(currentLevel);
            
            // Registra acesso e agenda notifica√ß√µes
            scheduleNotification();
        }

        function goHome() {
            playClickSound();
            // Salva o progresso
            document.getElementById('home-screen').style.display = 'flex';
            document.getElementById('nav-buttons').style.display = 'none';
            document.getElementById('home-level-display').innerText = `${t('level')} ${currentLevel}`;
            document.querySelector('.home-button').innerText = `${t('level')} ${currentLevel}`;
            
            // Limpa o tabuleiro
            boardEl.innerHTML = '';
            tilesOnBoard = [];
            tilesInTray = [];
            updateTrayUI();
            
            // Registra acesso
            scheduleNotification();
        }

        function openConfig() {
            playClickSound();
            document.getElementById('config-overlay').style.display = 'flex';
        }

        function closeConfig() {
            playClickSound();
            document.getElementById('config-overlay').style.display = 'none';
        }

        function toggleMusic() {
            playClickSound();
            settings.music = !settings.music;
            const toggle = document.getElementById('music-toggle');
            if (settings.music) {
                toggle.classList.remove('off');
                toggleMusicState(true);
            } else {
                toggle.classList.add('off');
                toggleMusicState(false);
            }
        }

        function toggleSound() {
            settings.sound = !settings.sound;
            const toggle = document.getElementById('sound-toggle');
            if (settings.sound) {
                toggle.classList.remove('off');
                toggleSoundState(true);
            } else {
                toggle.classList.add('off');
                toggleSoundState(false);
            }
            playClickSound();
        }

        function toggleNotification() {
            playClickSound();
            settings.notification = !settings.notification;
            const toggle = document.getElementById('notification-toggle');
            if (settings.notification) {
                toggle.classList.remove('off');
                requestNotificationPermission();
            } else {
                toggle.classList.add('off');
                cancelAllNotifications();
            }
            saveSettings();
        }

        // --- SISTEMA DE M√öSICA ---
        const bgMusic = document.getElementById('background-music');
        const clickSound = document.getElementById('click-sound');
        const victorySound = document.getElementById('victory-sound');
        const fruitSelectSound = document.getElementById('fruit-select-sound');
        let isMusicEnabled = true;
        let isSoundEnabled = true;

        function initMusic() {
            // Tenta tocar a m√∫sica quando o usu√°rio interagir pela primeira vez
            bgMusic.volume = 0.3; // Volume a 30%
            if (isMusicEnabled) {
                bgMusic.play().catch(err => {
                    console.log('M√∫sica ser√° reproduzida ap√≥s intera√ß√£o do usu√°rio');
                });
            }
        }

        function playClickSound() {
            if (isSoundEnabled) {
                clickSound.currentTime = 0; // Reinicia para tocar novamente
                clickSound.volume = 0.5; // Volume a 50%
                clickSound.play().catch(err => console.log('Erro ao tocar som:', err));
            }
        }

        function playVictorySound() {
            if (isSoundEnabled) {
                victorySound.currentTime = 0;
                victorySound.volume = 0.7; // Volume a 70%
                victorySound.play().catch(err => console.log('Erro ao tocar som de vit√≥ria:', err));
            }
        }

        function playFruitSelectSound() {
            if (isSoundEnabled) {
                fruitSelectSound.currentTime = 0;
                fruitSelectSound.volume = 0.6; // Volume a 60%
                fruitSelectSound.play().catch(err => console.log('Erro ao tocar som de fruta:', err));
            }
            // Vibra√ß√£o no dispositivo (se dispon√≠vel)
            if (navigator.vibrate) {
                navigator.vibrate(50); // Vibra por 50ms
            }
        }

        function toggleMusicState(enabled) {
            isMusicEnabled = enabled;
            if (enabled) {
                bgMusic.play().catch(err => console.log('Erro ao tocar m√∫sica:', err));
            } else {
                bgMusic.pause();
            }
        }

        function toggleSoundState(enabled) {
            isSoundEnabled = enabled;
        }

        // --- SISTEMA DE NOTIFICA√á√ïES ---
        let notificationPermissionGranted = false;
        let notificationTimer = null;
        const INACTIVITY_TIME = 24 * 60 * 60 * 1000; // 24 horas

        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('Notifica√ß√µes n√£o suportadas');
                return;
            }

            if (Notification.permission === 'granted') {
                notificationPermissionGranted = true;
                scheduleNotification();
            } else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        notificationPermissionGranted = true;
                        scheduleNotification();
                    }
                });
            }
        }

        function scheduleNotification() {
            if (!settings.notification || !notificationPermissionGranted) return;

            if (notificationTimer) clearTimeout(notificationTimer);

            notificationTimer = setTimeout(() => {
                sendNotification();
            }, INACTIVITY_TIME);

            localStorage.setItem('lastAccess', Date.now());
        }

        function sendNotification() {
            if (!settings.notification || !notificationPermissionGranted) return;

            const messages = {
                pt: {
                    title: 'üéÆ 7 Tiles - Jogo de Combinar',
                    body: 'Que saudade! Volte para completar mais n√≠veis e ganhar moedas! üèÜ'
                },
                en: {
                    title: 'üéÆ 7 Tiles - Match Game',
                    body: 'We miss you! Come back to complete more levels and earn coins! üèÜ'
                },
                es: {
                    title: 'üéÆ 7 Tiles - Juego de Combinar',
                    body: '¬°Te extra√±amos! ¬°Vuelve para completar m√°s niveles y ganar monedas! üèÜ'
                }
            };

            const msg = messages[currentLanguage] || messages.pt;

            new Notification(msg.title, {
                body: msg.body,
                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="80">üçé</text></svg>',
                tag: '7tiles-reminder'
            });

            scheduleNotification();
        }

        function cancelAllNotifications() {
            if (notificationTimer) {
                clearTimeout(notificationTimer);
                notificationTimer = null;
            }
        }

        function checkInactivityNotification() {
            if (!settings.notification) return;

            const lastAccess = localStorage.getItem('lastAccess');
            if (lastAccess) {
                const timeSinceLastAccess = Date.now() - parseInt(lastAccess);
                if (timeSinceLastAccess >= INACTIVITY_TIME && notificationPermissionGranted) {
                    sendNotification();
                }
            }
            scheduleNotification();
        }

        function saveSettings() {
            localStorage.setItem('gameSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('gameSettings');
            if (saved) {
                settings = { ...settings, ...JSON.parse(saved) };
                if (!settings.music) {
                    document.getElementById('music-toggle').classList.add('off');
                    toggleMusicState(false);
                }
                if (!settings.sound) {
                    document.getElementById('sound-toggle').classList.add('off');
                    toggleSoundState(false);
                }
                if (!settings.notification) {
                    document.getElementById('notification-toggle').classList.add('off');
                }
            }
        }

        // Inicia m√∫sica quando usu√°rio clicar em qualquer lugar (primeira intera√ß√£o)
        document.addEventListener('click', function initOnClick() {
            initMusic();
            document.removeEventListener('click', initOnClick);
        }, { once: true });

        // Inicializa configura√ß√µes e notifica√ß√µes
        loadSettings();
        if (settings.notification) {
            if (Notification.permission === 'granted') {
                notificationPermissionGranted = true;
                checkInactivityNotification();
            } else if (Notification.permission === 'default') {
                setTimeout(() => {
                    if (settings.notification) requestNotificationPermission();
                }, 5000);
            }
        }

        // --- SISTEMA DE IDIOMAS ---
        let selectedLanguage = 'pt'; // Tempor√°rio para sele√ß√£o no modal
        
        function openLanguageModal() {
            playClickSound();
            selectedLanguage = currentLanguage; // Inicia com idioma atual
            updateLanguageModal();
            document.getElementById('language-overlay').style.display = 'flex';
        }
        
        function closeLanguageModal() {
            playClickSound();
            document.getElementById('language-overlay').style.display = 'none';
        }
        
        function selectLanguage(lang) {
            playClickSound();
            selectedLanguage = lang;
            updateLanguageModal();
        }
        
        function updateLanguageModal() {
            // Remove sele√ß√£o de todos
            document.querySelectorAll('.language-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Adiciona sele√ß√£o ao escolhido
            const selected = document.getElementById(`lang-option-${selectedLanguage}`);
            if (selected) {
                selected.classList.add('selected');
            }
            
            // Atualiza t√≠tulo do modal
            const titles = {
                pt: 'L√≠ngua',
                en: 'Language',
                es: 'Idioma'
            };
            document.querySelector('.language-title').innerText = titles[selectedLanguage];
            
            // Atualiza texto do bot√£o confirmar
            const confirmTexts = {
                pt: 'Confirmar',
                en: 'Confirm',
                es: 'Confirmar'
            };
            document.querySelector('.language-confirm').innerText = confirmTexts[selectedLanguage];
        }
        
        function confirmLanguage() {
            currentLanguage = selectedLanguage;
            updateLanguage();
            closeLanguageModal();
        }

        // --- SISTEMA DE SELETOR DE N√çVEIS ---
        function openLevelSelector() {
            playClickSound();
            const levelGrid = document.getElementById('level-grid');
            levelGrid.innerHTML = '';
            
            // Gera bot√µes para todos os 100 n√≠veis
            for (let i = 1; i <= 100; i++) {
                const btn = document.createElement('button');
                btn.className = 'level-btn';
                btn.innerText = i;
                btn.onclick = () => selectAndStartLevel(i);
                levelGrid.appendChild(btn);
            }
            
            document.getElementById('level-selector-overlay').style.display = 'flex';
        }
        
        function closeLevelSelector() {
            playClickSound();
            document.getElementById('level-selector-overlay').style.display = 'none';
        }
        
        function selectAndStartLevel(level) {
            playClickSound();
            currentLevel = level;
            closeLevelSelector();
            document.getElementById('home-screen').style.display = 'none';
            document.getElementById('nav-buttons').style.display = 'flex';
            startLevel(currentLevel);
            scheduleNotification();
        }
        
        function changeLanguage(lang) {
            currentLanguage = lang;
            updateLanguage();
        }
        
        function updateLanguage() {
            // Atualiza t√≠tulos e labels
            document.querySelector('.config-title').innerText = t('config');
            document.querySelector('.shop-title').innerText = t('shop');
            
            // Atualiza labels das configura√ß√µes
            const configLabels = document.querySelectorAll('.config-label span:not(.config-icon)');
            configLabels[0].innerText = t('music');
            configLabels[1].innerText = t('sound');
            configLabels[2].innerText = t('notification');
            
            // Atualiza se√ß√µes da loja
            const shopSections = document.querySelectorAll('.shop-section-title');
            shopSections[0].innerHTML = `üí∞ ${t('coins')}`;
            shopSections[1].innerHTML = `‚ö° ${t('skills')}`;
            
            // Atualiza itens da loja
            const skillNames = document.querySelectorAll('.shop-item:not(.coin-package) .shop-item-name');
            const skillDescs = document.querySelectorAll('.shop-item:not(.coin-package) .shop-item-desc');
            
            if (skillNames[0]) skillNames[0].innerText = t('undo');
            if (skillDescs[0]) skillDescs[0].innerText = t('undoDesc');
            
            if (skillNames[1]) skillNames[1].innerText = t('shuffle');
            if (skillDescs[1]) skillDescs[1].innerText = t('shuffleDesc');
            
            if (skillNames[2]) skillNames[2].innerText = t('hint');
            if (skillDescs[2]) skillDescs[2].innerText = t('hintDesc');
            
            // Atualiza bot√µes de assistir an√∫ncio
            const watchBtns = document.querySelectorAll('.shop-price-btn.ad-option');
            watchBtns.forEach(btn => {
                btn.innerHTML = `üì∫ ${t('watch')}`;
            });
            
            // Atualiza pacotes de moedas
            const coinDescs = document.querySelectorAll('.coin-package .shop-item-desc');
            if (coinDescs[0]) coinDescs[0].innerText = t('smallPack');
            if (coinDescs[1]) coinDescs[1].innerText = t('mediumPack');
            if (coinDescs[2]) coinDescs[2].innerText = t('largePack');
            
            // Atualiza badge de n√≠vel
            document.getElementById('level-display').innerText = `${t('level')} ${currentLevel}`;
            document.getElementById('home-level-display').innerText = `${t('level')} ${currentLevel}`;
            document.querySelector('.home-button').innerText = `${t('level')} ${currentLevel}`;
            
            // Atualiza vers√£o
            const footer = document.querySelector('.config-footer');
            if (footer) footer.innerText = `${t('version')}: ${GAME_VERSION}`;
        }

        // --- LOJA (SHOP) ---
        function openShop() {
            playClickSound();
            document.getElementById('shop-overlay').style.display = 'flex';
        }

        function closeShop() {
            playClickSound();
            document.getElementById('shop-overlay').style.display = 'none';
        }

        function buyCoins(amount, price) {
            playClickSound();
            // Simula compra de moedas (integrar com sistema de pagamento real)
            if (confirm(`Comprar ${amount} moedas por R$ ${price.toFixed(2)}?`)) {
                coins += amount;
                updateCoinDisplay();
                closeShop();
                alert(`‚úÖ Voc√™ recebeu ${amount} moedas!`);
            }
        }

        function buySkillWithCoins(skillName) {
            const price = SKILL_PRICES[skillName];
            
            if (coins >= price) {
                if (confirm(`Comprar 1 uso de ${skillName} por ${price} moedas?`)) {
                    coins -= price;
                    skillUses[skillName]++;
                    updateCoinDisplay();
                    updateSkillUI(skillName);
                    closeShop();
                    alert(`‚úÖ Voc√™ comprou 1 uso de ${skillName}!`);
                }
            } else {
                alert(`‚ùå Moedas insuficientes! Voc√™ precisa de ${price} moedas.`);
            }
        }

        function buySkillWithAd(skillName) {
            closeShop();
            AdManager.showInterstitial(() => {
                skillUses[skillName]++;
                updateSkillUI(skillName);
                alert(`‚úÖ Voc√™ ganhou 1 uso de ${skillName}!`);
            });
        }

        const boardEl = document.getElementById('game-board');
        const levelDisplay = document.getElementById('level-display');
        const coinDisplay = document.getElementById('coin-display');
        const homeCoinDisplay = document.getElementById('home-coin-display');
        const overlay = document.getElementById('overlay');
        const modalContent = document.getElementById('modal-content');

        // Fun√ß√£o para atualizar display de moedas em ambos os lugares
        function updateCoinDisplay() {
            coinDisplay.innerText = coins;
            homeCoinDisplay.innerText = coins;
        }

        // --- SISTEMA DE AN√öNCIOS ---
        
        // Gerenciador de An√∫ncios Intersticiais (Tela Cheia)
        const AdManager = {
            interstitialLoaded: false,
            
            // Inicializa os an√∫ncios
            init: function() {
                // Carrega an√∫ncios banner
                this.loadBannerAd();
                
                // Pr√©-carrega an√∫ncio intersticial
                this.preloadInterstitial();
            },
            
            // Carrega banner do AdSense
            loadBannerAd: function() {
                try {
                    (adsbygoogle = window.adsbygoogle || []).push({});
                } catch (e) {
                    console.log('Banner ad not loaded:', e);
                }
            },
            
            // Pr√©-carrega an√∫ncio intersticial
            preloadInterstitial: function() {
                // Simula carregamento (na vers√£o real, use Google AdMob SDK)
                setTimeout(() => {
                    this.interstitialLoaded = true;
                    console.log('Intersticial carregado');
                }, 2000);
            },
            
            // Mostra an√∫ncio intersticial (tela cheia)
            showInterstitial: function(callback) {
                if (!this.interstitialLoaded) {
                    console.log('An√∫ncio n√£o carregado, simulando...');
                    this.simulateAd(callback);
                    return;
                }
                
                // Aqui ser√° integrado o c√≥digo real do AdMob
                // Por enquanto, simula o an√∫ncio
                this.simulateAd(callback);
                
                // Recarrega pr√≥ximo an√∫ncio
                this.interstitialLoaded = false;
                this.preloadInterstitial();
            },
            
            // Simula an√∫ncio para testes
            simulateAd: function(callback) {
                modalContent.innerHTML = `
                    <h1>üì∫ PROPAGANDA</h1>
                    <p>Assistindo an√∫ncio...</p>
                    <div style="font-size: 3rem; margin: 20px;">üé¨</div>
                    <div style="background: #333; color: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <p style="color: white; margin: 5px 0;">An√∫ncio simulado</p>
                        <p style="color: #888; font-size: 0.9rem;">Na vers√£o real, aqui ser√° exibido<br>um an√∫ncio do Google AdMob</p>
                    </div>
                    <p id="ad-countdown" style="color: #666;">Aguarde 3 segundos...</p>
                `;
                
                let countdown = 3;
                const countdownEl = document.getElementById('ad-countdown');
                
                const adTimer = setInterval(() => {
                    countdown--;
                    if (countdownEl) {
                        countdownEl.innerText = countdown > 0 ? `Aguarde ${countdown} segundos...` : 'Fechando...';
                    }
                    
                    if (countdown <= 0) {
                        clearInterval(adTimer);
                        if (callback) callback();
                    }
                }, 1000);
            }
        };
        
        // Inicializa sistema de an√∫ncios quando p√°gina carregar
        window.addEventListener('load', () => {
            AdManager.init();
            
            // Inicializa vers√£o do jogo
            const versionElement = document.getElementById('game-version');
            if (versionElement) {
                versionElement.innerText = GAME_VERSION;
            }
            
            // Inicializa sele√ß√£o de idioma
            updateLanguageModal();
        });

        // --- DEFINI√á√ÉO DE LAYOUTS (MAPAS) ---
        // x, y: Posi√ß√£o em pixels (relativo ao centro 350x400)
        // z: Camada (0 = base, 1 = meio, 2 = topo)
        
        // Helper para criar grade
        function grid(col, row, layer) {
            return { x: col * 55, y: row * 58, z: layer };
        }

        // --- GERADOR DE N√çVEIS DIN√ÇMICO ---
        function generateLevel(levelNum) {
            // Progress√£o de dificuldade agressiva
            const difficulty = Math.min(Math.floor((levelNum - 1) / 3), 33); // 0-33 (grupos de 3 n√≠veis)
            
            // LIMITES PARA CABER NA TELA DE CELULAR (700x800px √°rea √∫til)
            // Tile = 60x66px, espa√ßamento = 55x58px
            const maxCols = 6; // M√°ximo 6 colunas (6 * 55 = 330px)
            const maxRows = 6; // M√°ximo 6 linhas (6 * 58 = 348px)
            
            // PROGRESS√ÉO MUITO MAIS AGRESSIVA
            let baseSize, layers, typesCount;
            
            if (levelNum === 1) {
                // N√≠vel 1: 9 pe√ßas (3x3, 1 camada, 3 tipos)
                baseSize = 3;
                layers = 1;
                typesCount = 3;
            } else if (levelNum <= 3) {
                // N√≠veis 2-3: 12-15 pe√ßas
                baseSize = 3;
                layers = 1 + Math.floor((levelNum - 1) / 2);
                typesCount = 3;
            } else if (levelNum <= 6) {
                // N√≠veis 4-6: 18-24 pe√ßas, come√ßa 2 camadas
                baseSize = 4;
                layers = 2;
                typesCount = 4;
            } else if (levelNum <= 10) {
                // N√≠veis 7-10: 24-30 pe√ßas, 3 camadas
                baseSize = 4;
                layers = 3;
                typesCount = 5 + Math.floor((levelNum - 7) / 2);
            } else if (levelNum <= 20) {
                // N√≠veis 11-20: 4-5 camadas, aumenta tipos
                baseSize = Math.min(4 + Math.floor((levelNum - 10) / 5), 5);
                layers = 3 + Math.floor((levelNum - 10) / 5);
                typesCount = 6 + Math.floor((levelNum - 10) / 2);
            } else if (levelNum <= 40) {
                // N√≠veis 21-40: 5-7 camadas
                baseSize = Math.min(5 + Math.floor((levelNum - 20) / 10), maxCols);
                layers = 5 + Math.floor((levelNum - 20) / 10);
                typesCount = 10 + Math.floor((levelNum - 20) / 3);
            } else if (levelNum <= 70) {
                // N√≠veis 41-70: 7-10 camadas
                baseSize = maxCols;
                layers = 7 + Math.floor((levelNum - 40) / 10);
                typesCount = 15 + Math.floor((levelNum - 40) / 5);
            } else {
                // N√≠veis 71-100: 10-12 camadas (INSANO!)
                baseSize = maxCols;
                layers = Math.min(10 + Math.floor((levelNum - 70) / 10), 12);
                typesCount = Math.min(20 + Math.floor((levelNum - 70) / 3), 30);
            }
            
            let layout = [];
            
            // Gera base (grade completa ou padr√£o)
            const pattern = levelNum % 5;
            
            if (pattern === 0) { // Grade completa
                for (let y = 0; y < baseSize; y++) {
                    for (let x = 0; x < baseSize; x++) {
                        layout.push(grid(x, y, 0));
                    }
                }
            } else if (pattern === 1) { // Cruz
                const center = Math.floor(baseSize / 2);
                for (let i = 0; i < baseSize; i++) {
                    layout.push(grid(i, center, 0)); // Horizontal
                    if (i !== center) { // Evita duplicar centro
                        layout.push(grid(center, i, 0)); // Vertical
                    }
                }
            } else if (pattern === 2) { // Diamante
                const center = Math.floor(baseSize / 2);
                for (let y = 0; y < baseSize; y++) {
                    for (let x = 0; x < baseSize; x++) {
                        const dist = Math.abs(x - center) + Math.abs(y - center);
                        if (dist <= center) {
                            layout.push(grid(x, y, 0));
                        }
                    }
                }
            } else if (pattern === 3) { // C√≠rculo
                const center = baseSize / 2;
                const radius = center - 0.5;
                for (let y = 0; y < baseSize; y++) {
                    for (let x = 0; x < baseSize; x++) {
                        const dist = Math.sqrt(Math.pow(x - center + 0.5, 2) + Math.pow(y - center + 0.5, 2));
                        if (dist <= radius) {
                            layout.push(grid(x, y, 0));
                        }
                    }
                }
            } else { // Xadrez ou aleat√≥rio
                for (let y = 0; y < baseSize; y++) {
                    for (let x = 0; x < baseSize; x++) {
                        if ((x + y) % 2 === 0 || difficulty > 5) {
                            layout.push(grid(x, y, 0));
                        }
                    }
                }
            }
            
            // Adiciona camadas superiores (pir√¢mide) - SUPORTA AT√â 12 CAMADAS
            // Estrat√©gia: camadas centralizadas para for√ßar desbloquear v√°rias pe√ßas
            for (let layer = 1; layer < layers; layer++) {
                // Reduz tamanho gradualmente mas mant√©m pe√ßas suficientes
                let layerSize;
                if (layer <= 3) {
                    layerSize = Math.max(2, baseSize - layer);
                } else if (layer <= 6) {
                    layerSize = Math.max(3, baseSize - Math.floor(layer * 0.6));
                } else {
                    // Camadas muito altas: mant√©m 3x3 para criar mais bloqueios
                    layerSize = Math.max(3, Math.floor(baseSize * 0.5));
                }
                
                // Offset centralizado para criar mais sobreposi√ß√µes estrat√©gicas
                const offset = Math.floor((baseSize - layerSize) / 2);
                
                for (let y = 0; y < layerSize && (y + offset) < maxRows; y++) {
                    for (let x = 0; x < layerSize && (x + offset) < maxCols; x++) {
                        // Densidade: mais pe√ßas em camadas m√©dias para criar bloqueios
                        let density;
                        if (layer <= 2) {
                            density = 0.1; // Poucas pe√ßas nas primeiras camadas
                        } else if (layer <= 5) {
                            density = 0; // Muitas pe√ßas nas camadas m√©dias (mais bloqueio)
                        } else if (layer <= 8) {
                            density = 0.2; // Menos pe√ßas em camadas altas
                        } else {
                            density = 0.3; // Ainda menos nas camadas muito altas
                        }
                        
                        if (Math.random() > density) {
                            layout.push(grid(x + offset, y + offset, layer));
                        }
                    }
                }
            }
            
            return { layout, typesCount };
        }

        const LEVELS = {};
        // Gera 100 n√≠veis dinamicamente
        for (let i = 1; i <= 100; i++) {
            LEVELS[i] = generateLevel(i);
        }

        // --- L√ìGICA DE INICIALIZA√á√ÉO ---

        function startLevel(lvl) {
            currentLevel = lvl;
            levelDisplay.innerText = t('level') + " " + currentLevel;
            overlay.style.display = 'none';
            tilesInTray = [];
            tilesOnBoard = [];
            boardEl.innerHTML = '';
            updateTrayUI();

            // 1. Carrega Layout
            let config = LEVELS[currentLevel];
            if (!config) {
                // Se acabou os n√≠veis, volta pro 1 ou gera random (aqui volta pro 1)
                config = LEVELS[1];
                const completeMsg = currentLanguage === 'pt' ? 'Voc√™ zerou o prot√≥tipo! Voltando ao N√≠vel 1.' : 
                                   currentLanguage === 'en' ? 'You completed the prototype! Back to Level 1.' : 
                                   '¬°Completaste el prototipo! Volviendo al Nivel 1.';
                alert(completeMsg);
                currentLevel = 1;
                levelDisplay.innerText = t('level') + " 1";
            }

            // 2. Prepara Tipos de Pe√ßas (Garantir trios)
            const totalSlots = config.layout.length;
            
            // IMPORTANTE: Total DEVE ser divis√≠vel por 3 para garantir que todas as pe√ßas formem trios
            const workableSlots = Math.floor(totalSlots / 3) * 3; // For√ßa divisibilidade por 3
            const layoutToUse = config.layout.slice(0, workableSlots);
            
            const triosNeeded = workableSlots / 3;
            
            // Seleciona frutas aleat√≥rias (limitado pelo typesCount do n√≠vel)
            let availableTypes = [...ALL_TILE_TYPES].sort(() => 0.5 - Math.random()).slice(0, config.typesCount);
            
            // NOVA L√ìGICA: Distribui trios completos de forma equilibrada
            let typesPool = [];
            
            // Calcula quantos trios cada tipo deve ter (distribui√ß√£o equilibrada)
            const triosPerType = Math.floor(triosNeeded / availableTypes.length);
            const remainingTrios = triosNeeded % availableTypes.length;
            
            // Adiciona trios equilibrados para cada tipo
            availableTypes.forEach((type, index) => {
                const trios = triosPerType + (index < remainingTrios ? 1 : 0);
                for (let i = 0; i < trios; i++) {
                    typesPool.push(type, type, type); // Sempre 3 pe√ßas por trio
                }
            });

            // Embaralha a piscina de pe√ßas
            typesPool.sort(() => 0.5 - Math.random());

            // 3. Cria as pe√ßas no Tabuleiro
            layoutToUse.forEach((pos, index) => {
                createTile(typesPool[index], pos.x, pos.y, pos.z);
            });

            // 4. Calcula bloqueios iniciais
            checkBlockedTiles();
        }

        function createTile(type, x, y, z) {
            const tile = {
                id: Math.random().toString(36),
                type: type,
                x: x, y: y, z: z,
                el: null,
                blocked: false
            };

            const el = document.createElement('div');
            el.classList.add('tile');
            el.innerText = type;
            
            // Offset visual para mostrar camadas (cada camada desloca -3px em x e y)
            const visualOffset = z * -3;
            el.style.left = (x + visualOffset) + 'px';
            el.style.top = (y + visualOffset) + 'px';
            
            // Z-index e sombra baseados na camada
            el.style.zIndex = 10 + z;
            
            // Cor e sombra progressivas por camada
            if (z === 0) {
                el.style.backgroundColor = "#e8e8e8"; // Base mais escura
                el.style.boxShadow = "inset 0 -4px 0 #d0d0d0, 0 2px 0 #aaa, 0 3px 4px rgba(0,0,0,0.2)";
            } else if (z <= 3) {
                el.style.backgroundColor = "#f0f0f0";
                el.style.boxShadow = `inset 0 -4px 0 #dcdcdc, 0 ${4 + z}px 0 #bbb, 0 ${6 + z * 2}px ${6 + z * 2}px rgba(0,0,0,${0.3 + z * 0.05})`;
            } else if (z <= 6) {
                el.style.backgroundColor = "#f8f8f8";
                el.style.boxShadow = `inset 0 -4px 0 #e0e0e0, 0 ${8 + z}px 0 #bbb, 0 ${12 + z * 2}px ${12 + z * 2}px rgba(0,0,0,${0.4 + z * 0.03})`;
            } else {
                el.style.backgroundColor = "#fdfdfd"; // Topo mais claro
                el.style.boxShadow = `inset 0 -5px 0 #dcdcdc, 0 ${12 + z}px 0 #bbb, 0 ${18 + z * 2}px ${18 + z * 2}px rgba(0,0,0,${0.5 + z * 0.02})`;
            }

            el.onclick = () => handleTileClick(tile);
            
            boardEl.appendChild(el);
            tile.el = el;
            tilesOnBoard.push(tile);
        }

        // --- L√ìGICA DE JOGO ---

        function checkBlockedTiles() {
            // IMPORTANTE: Verifica pe√ßa por pe√ßa individualmente
            // Cada pe√ßa s√≥ √© bloqueada se tiver OUTRA pe√ßa em cima dela
            tilesOnBoard.forEach(lower => {
                lower.blocked = false;
                
                // Procura se tem QUALQUER pe√ßa em cima (mesmo parcial)
                for (let upper of tilesOnBoard) {
                    if (upper === lower) continue;
                    
                    // Se est√° numa camada superior (mesmo que seja 1 camada acima)
                    if (upper.z > lower.z) {
                        // Verifica QUALQUER sobreposi√ß√£o (considera offset visual)
                        const upperVisualX = upper.x + (upper.z * -3);
                        const upperVisualY = upper.y + (upper.z * -3);
                        const lowerVisualX = lower.x + (lower.z * -3);
                        const lowerVisualY = lower.y + (lower.z * -3);
                        
                        // Dimens√µes da tile
                        const tileWidth = 60;
                        const tileHeight = 66;
                        
                        // Calcula limites de cada tile
                        const upperLeft = upperVisualX;
                        const upperRight = upperVisualX + tileWidth;
                        const upperTop = upperVisualY;
                        const upperBottom = upperVisualY + tileHeight;
                        
                        const lowerLeft = lowerVisualX;
                        const lowerRight = lowerVisualX + tileWidth;
                        const lowerTop = lowerVisualY;
                        const lowerBottom = lowerVisualY + tileHeight;
                        
                        // Verifica se h√° QUALQUER sobreposi√ß√£o (mesmo 1px)
                        const hasOverlap = !(
                            upperRight <= lowerLeft ||   // upper est√° totalmente √† esquerda
                            upperLeft >= lowerRight ||   // upper est√° totalmente √† direita
                            upperBottom <= lowerTop ||   // upper est√° totalmente acima
                            upperTop >= lowerBottom      // upper est√° totalmente abaixo
                        );
                        
                        // Se houver QUALQUER sobreposi√ß√£o, bloqueia
                        if (hasOverlap) {
                            lower.blocked = true;
                            break; // J√° encontrou bloqueio, n√£o precisa continuar
                        }
                    }
                }
                
                // Update Visual - Pe√ßas bloqueadas ficam escuras e com cursor bloqueado
                if (lower.blocked) {
                    lower.el.classList.add('blocked');
                    lower.el.style.opacity = '0.6'; // Bem escuras
                    lower.el.style.cursor = 'not-allowed';
                    lower.el.style.filter = 'brightness(0.7)'; // Escurece mais ainda
                } else {
                    lower.el.classList.remove('blocked');
                    lower.el.style.opacity = '1';
                    lower.el.style.cursor = 'pointer';
                    lower.el.style.filter = 'brightness(1)';
                }
            });
        }

        function handleTileClick(tile) {
            // Impede clique em pe√ßas bloqueadas ou durante processamento
            if (tile.blocked || isProcessing) {
                // Feedback visual quando tenta clicar em bloqueada
                if (tile.blocked && tile.el) {
                    tile.el.style.animation = 'shake 0.3s';
                    setTimeout(() => {
                        if (tile.el) tile.el.style.animation = '';
                    }, 300);
                }
                return;
            }
            
            // Game Over check pr√©vio
            if (tilesInTray.length >= TRAY_CAPACITY) return;

            // Toca som e vibra ao selecionar fruta
            playFruitSelectSound();

            // Salva para undo
            lastMove = { tile: tile, boardState: [...tilesOnBoard], trayState: [...tilesInTray] };

            // 1. Move dados
            tilesOnBoard = tilesOnBoard.filter(t => t !== tile);
            tilesInTray.push(tile);

            // 2. Anima√ß√£o visual simples (some do board)
            tile.el.style.display = 'none'; // No futuro, animar voando
            
            // 3. Recalcula bloqueios e tabuleiro
            checkBlockedTiles();
            updateTrayUI();

            // 4. Verifica Match (com pequeno delay visual)
            isProcessing = true;
            setTimeout(() => {
                checkMatch();
                isProcessing = false;
                checkGameState();
            }, 200);
        }

        function updateTrayUI() {
            const slots = document.querySelectorAll('.slot');
            slots.forEach(s => s.innerHTML = '');

            // Ordena pe√ßas na bandeja para facilitar visualiza√ß√£o do match
            let displayList = [...tilesInTray]; 

            displayList.forEach((tile, i) => {
                if (i < 7 && slots[i]) {
                    const el = document.createElement('div');
                    el.className = 'tile';
                    el.style.position = 'static';
                    el.style.boxShadow = 'none';
                    el.style.border = '1px solid #ccc';
                    el.style.transform = 'none';
                    el.innerText = tile.type;
                    slots[i].appendChild(el);
                }
            });
        }

        function checkMatch() {
            const counts = {};
            tilesInTray.forEach(t => counts[t.type] = (counts[t.type] || 0) + 1);

            for (let type in counts) {
                if (counts[type] >= 3) {
                    // Remove 3
                    let removed = 0;
                    tilesInTray = tilesInTray.filter(t => {
                        if (t.type === type && removed < 3) {
                            removed++;
                            // Anima√ß√£o de pontos aqui
                            addCoins(10);
                            return false;
                        }
                        return true;
                    });
                    updateTrayUI();
                    break; // S√≥ um match por vez
                }
            }
        }

        function checkGameState() {
            // Primeiro verifica vit√≥ria
            if (tilesOnBoard.length === 0 && tilesInTray.length === 0) {
                showWinModal();
                return;
            }
            
            // Verifica Game Over SOMENTE se n√£o h√° possibilidade de match
            // N√£o verifica se a bandeja est√° "quase cheia" - s√≥ quando realmente sem espa√ßo
            if (tilesInTray.length >= TRAY_CAPACITY) {
                // Verifica se h√° algum trio prestes a formar
                const counts = {};
                tilesInTray.forEach(t => counts[t.type] = (counts[t.type] || 0) + 1);
                
                // Se algum tipo j√° tem 3+, n√£o √© game over ainda (o match vai processar)
                for (let type in counts) {
                    if (counts[type] >= 3) {
                        return; // N√£o mostra game over, deixa o match processar
                    }
                }
                
                // S√≥ mostra game over se realmente n√£o h√° matches poss√≠veis
                showLoseModal();
            }
        }
        
        function hasValidMoves() {
            // Verifica se h√° pelo menos uma pe√ßa n√£o bloqueada
            const availableTiles = tilesOnBoard.filter(t => !t.blocked);
            if (availableTiles.length === 0) return false;
            
            // Verifica se consegue completar pelo menos um trio com as pe√ßas dispon√≠veis
            const allTiles = [...tilesOnBoard, ...tilesInTray];
            const typeCounts = {};
            allTiles.forEach(t => {
                typeCounts[t.type] = (typeCounts[t.type] || 0) + 1;
            });
            
            // Se algum tipo tem menos de 3 pe√ßas no total, √© imposs√≠vel completar
            for (let type in typeCounts) {
                if (typeCounts[type] % 3 !== 0) {
                    console.error('Erro no n√≠vel: Tipo', type, 'tem', typeCounts[type], 'pe√ßas (n√£o divis√≠vel por 3)');
                    return false;
                }
            }
            
            return true;
        }
        
        function showNoMovesModal() {
            modalContent.innerHTML = `
                <h1>‚ö†Ô∏è SEM JOGADAS!</h1>
                <p>N√£o h√° mais movimentos poss√≠veis</p>
                <div style="font-size: 3rem; margin: 20px;">üîÑ</div>
                <button class="btn-primary" onclick="retryLevel()">REINICIAR N√çVEL</button>
            `;
            overlay.style.display = 'flex';
        }

        function addCoins(amount) {
            coins += amount;
            updateCoinDisplay();
            // Efeito visual simples (piscar)
            coinDisplay.style.color = 'green';
            setTimeout(() => coinDisplay.style.color = '#333', 300);
        }

        // --- SISTEMA DE SKILLS ---
        
        function useSkill(skillType) {
            // Verifica se tem usos dispon√≠veis
            if (skillUses[skillType] <= 0) {
                // Mostra modal de compra/propaganda
                showUnlockModal(skillType);
                return;
            }
            
            // Executa a skill e s√≥ consome se for bem-sucedida
            let success = false;
            
            switch(skillType) {
                case 'undo':
                    success = undoLastMove();
                    break;
                case 'shuffle':
                    shuffleBoard();
                    success = true;
                    break;
                case 'hint':
                    success = showHint();
                    break;
            }
            
            // S√≥ consome o uso se a skill foi executada com sucesso
            if (success) {
                skillUses[skillType]--;
                updateSkillCounter(skillType);
            }
        }
        
        function updateSkillCounter(skillType) {
            const counter = document.getElementById(`${skillType}-counter`);
            const lock = document.getElementById(`${skillType}-lock`);
            
            if (skillUses[skillType] > 0) {
                counter.style.display = 'flex';
                counter.innerText = skillUses[skillType];
                lock.style.display = 'none';
            } else {
                counter.style.display = 'none';
                lock.style.display = 'flex';
            }
        }
        
        function showUnlockModal(skillType) {
            const price = SKILL_PRICES[skillType];
            const skillNames = {
                undo: '‚Ü©Ô∏è',
                shuffle: 'üîÄ',
                hint: 'üí°'
            };
            
            const skillNamesText = {
                undo: 'Desfazer',
                shuffle: 'Embaralhar',
                hint: 'Dica'
            };
            
            const skillDescriptions = {
                undo: 'Remove a √∫ltima pe√ßa da bandeja',
                shuffle: 'Reorganiza as pe√ßas no tabuleiro',
                hint: 'Destaca uma pe√ßa dispon√≠vel'
            };
            
            modalContent.innerHTML = `
                <div style="position: relative;">
                    <h1 style="font-size: 1.8rem; margin: 0 0 15px 0; color: #2c3e50;">Skill</h1>
                    <div style="font-size: 3.5rem; margin: 15px 0; background: linear-gradient(135deg, #60a3f8, #4a90e2); width: 80px; height: 80px; border-radius: 15px; display: flex; align-items: center; justify-content: center; margin: 15px auto; box-shadow: 0 4px 15px rgba(74,144,226,0.3);">${skillNames[skillType]}</div>
                    
                    <h2 style="color: #333; margin: 10px 0; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        ${skillNamesText[skillType]} ${skillNames[skillType]}
                    </h2>
                    <p style="color: #7f8c8d; font-size: 0.95rem; margin: 8px 0;">${skillDescriptions[skillType]}</p>
                    <p style="color: #95a5a6; font-size: 0.85rem; margin: 12px 0;">Cada compra = 1 uso</p>
                    
                    <div style="background: #ecf0f1; padding: 12px; border-radius: 10px; margin: 15px 0;">
                        <p style="color: #2c3e50; font-weight: bold; margin: 0; font-size: 0.95rem;">Escolha uma op√ß√£o:</p>
                    </div>
                    
                    <!-- Op√ß√£o 1: Moedas -->
                    <div style="background: white; border: 3px solid #f39c12; border-radius: 12px; padding: 12px 15px; margin: 10px 0;">
                        <div style="font-size: 1.5rem; color: #f39c12; font-weight: bold; margin-bottom: 8px;">
                            üí∞ ${price} moedas
                        </div>
                        <p style="color: ${coins >= price ? '#27ae60' : '#e74c3c'}; font-weight: bold; margin: 8px 0; font-size: 0.9rem;">
                            Voc√™ tem: ${coins} moedas
                        </p>
                        ${coins >= price ? 
                            `<button onclick="unlockSkillWithCoins('${skillType}')" style="background: linear-gradient(135deg, #27ae60, #229954); color: white; border: none; border-radius: 25px; padding: 12px 25px; font-size: 1rem; font-weight: bold; width: 100%; cursor: pointer; box-shadow: 0 3px 10px rgba(39,174,96,0.3); margin-top: 5px;">COMPRAR COM MOEDAS</button>` :
                            `<button style="background: #bdc3c7; color: white; border: none; border-radius: 25px; padding: 12px 25px; font-size: 1rem; font-weight: bold; width: 100%; cursor: not-allowed; margin-top: 5px; opacity: 0.6;">MOEDAS INSUFICIENTES</button>`
                        }
                    </div>
                    
                    <!-- Op√ß√£o 2: Propaganda -->
                    <div style="background: white; border: 3px solid #00d2d3; border-radius: 12px; padding: 12px 15px; margin: 10px 0;">
                        <div style="font-size: 1.5rem; color: #00d2d3; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            üì∫ Assistir An√∫ncio
                        </div>
                        <p style="color: #7f8c8d; margin: 8px 0; font-size: 0.9rem;">
                            Ganhe 1 uso gr√°tis
                        </p>
                        <button onclick="unlockSkillWithAd('${skillType}')" style="background: linear-gradient(135deg, #00d084, #00a368); color: white; border: none; border-radius: 25px; padding: 12px 25px; font-size: 1rem; font-weight: bold; width: 100%; cursor: pointer; box-shadow: 0 3px 10px rgba(0,208,132,0.3); margin-top: 5px;">
                            VER AN√öNCIO GR√ÅTIS
                        </button>
                    </div>
                    
                    <button onclick="overlay.style.display='none'" style="position: absolute; top: -15px; right: -15px; background: #e74c3c; border: 2px solid white; border-radius: 50%; width: 40px; height: 40px; font-size: 1.3rem; color: white; cursor: pointer; box-shadow: 0 3px 10px rgba(0,0,0,0.3); font-weight: bold; display: flex; align-items: center; justify-content: center;">‚úï</button>
                </div>
            `;
            overlay.style.display = 'flex';
        }
        
        function unlockSkillWithCoins(skillType) {
            const price = SKILL_PRICES[skillType];
            
            if (coins >= price) {
                coins -= price;
                updateCoinDisplay();
                skillUses[skillType]++;
                updateSkillCounter(skillType);
                
                // Mostra mensagem de sucesso
                modalContent.innerHTML = `
                    <h1>‚úÖ COMPRADO!</h1>
                    <div style="font-size: 4rem; margin: 20px;">üéâ</div>
                    <p style="color: #27ae60; font-size: 1.2rem; font-weight: bold;">
                        +1 uso adicionado!
                    </p>
                    <p style="color: #666;">Usos dispon√≠veis: ${skillUses[skillType]}</p>
                    <button class="btn-primary" onclick="overlay.style.display='none'">OK</button>
                `;
            }
        }
        
        function unlockSkillWithAd(skillType) {
            overlay.style.display = 'none';
            
            // Mostra an√∫ncio
            AdManager.showInterstitial(() => {
                // Ap√≥s o an√∫ncio, adiciona 1 uso
                skillUses[skillType]++;
                updateSkillCounter(skillType);
                
                // Mostra mensagem de sucesso
                modalContent.innerHTML = `
                    <h1>‚úÖ DESBLOQUEADO!</h1>
                    <div style="font-size: 4rem; margin: 20px;">üéÅ</div>
                    <p style="color: #27ae60; font-size: 1.2rem; font-weight: bold;">
                        +1 uso adicionado gratuitamente!
                    </p>
                    <p style="color: #666;">Usos dispon√≠veis: ${skillUses[skillType]}</p>
                    <button class="btn-primary" onclick="overlay.style.display='none'">OK</button>
                `;
                overlay.style.display = 'flex';
            });
        }
        
        // Skills funcionais
        let lastMove = null; // Guarda √∫ltima jogada para undo
        
        function undoLastMove() {
            if (!lastMove || tilesInTray.length === 0) {
                alert('Nenhuma jogada para desfazer!');
                return false; // Retorna false para n√£o consumir o uso
            }
            
            // Remove √∫ltima pe√ßa da bandeja
            const lastTile = tilesInTray.pop();
            
            // Retorna ao tabuleiro
            tilesOnBoard.push(lastTile);
            
            // Recria elemento visual
            const el = document.createElement('div');
            el.classList.add('tile');
            el.innerText = lastTile.type;
            el.style.left = lastTile.x + 'px';
            el.style.top = lastTile.y + 'px';
            el.style.zIndex = 10 + lastTile.z;
            if (lastTile.z === 0) el.style.backgroundColor = "#eee";
            el.onclick = () => handleTileClick(lastTile);
            boardEl.appendChild(el);
            lastTile.el = el;
            
            checkBlockedTiles();
            updateTrayUI();
            lastMove = null;
            
            return true; // Retorna true para consumir o uso
        }

        function shuffleBoard() {
            // Embaralha tipos no board
            const types = tilesOnBoard.map(t => t.type);
            types.sort(() => Math.random() - 0.5);
            tilesOnBoard.forEach((t, i) => {
                t.type = types[i];
                t.el.innerText = t.type;
            });
        }
        
        function showHint() {
            // Encontra a melhor jogada (pe√ßa que tem par na bandeja ou que formaria trio)
            let bestTile = null;
            
            // Primeiro, procura pe√ßa que formaria trio na bandeja
            const trayTypes = tilesInTray.map(t => t.type);
            for (let tile of tilesOnBoard) {
                if (tile.blocked) continue;
                
                const typeCount = trayTypes.filter(t => t === tile.type).length;
                if (typeCount === 2) {
                    // Essa pe√ßa completaria um trio!
                    bestTile = tile;
                    break;
                }
            }
            
            // Se n√£o encontrou trio, procura pe√ßa que tem pelo menos 1 par na bandeja
            if (!bestTile) {
                for (let tile of tilesOnBoard) {
                    if (tile.blocked) continue;
                    
                    const typeCount = trayTypes.filter(t => t === tile.type).length;
                    if (typeCount >= 1) {
                        bestTile = tile;
                        break;
                    }
                }
            }
            
            // Se ainda n√£o encontrou, pega qualquer pe√ßa dispon√≠vel
            if (!bestTile) {
                bestTile = tilesOnBoard.find(t => !t.blocked);
            }
            
            if (!bestTile || !bestTile.el) {
                alert('Nenhuma dica dispon√≠vel!');
                return false;
            }
            
            // Adiciona anima√ß√£o de balan√ßo e destaque
            bestTile.el.style.border = '3px solid #f39c12';
            bestTile.el.style.boxShadow = '0 0 20px #f39c12';
            
            // Anima√ß√£o de balan√ßo (shake)
            let shakeCount = 0;
            const shakeInterval = setInterval(() => {
                const angle = shakeCount % 2 === 0 ? 10 : -10;
                bestTile.el.style.transform = `rotate(${angle}deg) scale(1.1)`;
                shakeCount++;
                
                if (shakeCount >= 6) {
                    clearInterval(shakeInterval);
                    bestTile.el.style.transform = 'rotate(0deg) scale(1)';
                }
            }, 100);
            
            // Remove destaque ap√≥s 3 segundos
            setTimeout(() => {
                if (bestTile.el) {
                    bestTile.el.style.border = '1px solid #eee';
                    bestTile.el.style.boxShadow = 'inset 0 -4px 0 #dcdcdc, 0 4px 0 #bbb, 0 6px 6px rgba(0,0,0,0.3)';
                    bestTile.el.style.transform = 'rotate(0deg) scale(1)';
                }
            }, 3000);
            
            return true;
        }

        // --- MODAIS ---

        function showWinModal() {
            // Toca som de vit√≥ria
            playVictorySound();
            
            // Calcula recompensa de moedas
            const coinReward = currentLevel * 50; // 50 moedas por n√≠vel
            
            // Cria confetes
            createConfetti();
            
            modalContent.innerHTML = `
                <div class="victory-screen">
                    <div class="victory-banner">
                        <p class="victory-title">${t('levelComplete')}</p>
                        <h1 class="victory-level">${t('level').toUpperCase()} ${currentLevel}</h1>
                    </div>
                    
                    <div class="coin-reward">
                        <div class="coin-icon">üí∞</div>
                        <p style="color: #666; margin: 5px 0;">${t('reward')}</p>
                        <div class="coin-amount">+${coinReward} ${currentLanguage === 'en' ? 'coins' : currentLanguage === 'es' ? 'monedas' : 'moedas'}</div>
                    </div>
                    
                    <div class="next-level-box" onclick="nextLevel()">
                        <p class="next-level-text">${t('level')} ${currentLevel + 1}</p>
                    </div>
                </div>
            `;
            overlay.style.display = 'flex';
            
            // Adiciona moedas ap√≥s 1 segundo (durante anima√ß√£o)
            setTimeout(() => {
                addCoins(coinReward);
            }, 1000);
        }
        
        function createConfetti() {
            const colors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#54a0ff', '#00d2d3'];
            const confettiCount = 50;
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 3 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetti);
                
                // Remove ap√≥s anima√ß√£o
                setTimeout(() => confetti.remove(), 5000);
            }
        }

        function showLoseModal() {
            // Salva estado do jogo
            gameOverState = {
                boardTiles: [...tilesOnBoard],
                trayTiles: [...tilesInTray],
                level: currentLevel
            };
            
            // Mostra modal com contador
            countdownSeconds = 5;
            const trayFullText = currentLanguage === 'pt' ? 'BANDEJA CHEIA!' : currentLanguage === 'en' ? 'TRAY FULL!' : '¬°BANDEJA LLENA!';
            const watchAdText = currentLanguage === 'pt' ? 'Assista um an√∫ncio para continuar' : currentLanguage === 'en' ? 'Watch an ad to continue' : 'Mira un anuncio para continuar';
            const waitText = currentLanguage === 'pt' ? 'Ou aguarde' : currentLanguage === 'en' ? 'Or wait' : 'O espera';
            const restartText = currentLanguage === 'pt' ? 's para reiniciar' : currentLanguage === 'en' ? 's to restart' : 's para reiniciar';
            
            modalContent.innerHTML = `
                <h1>${trayFullText}</h1>
                <p>${watchAdText}</p>
                <div class="countdown-circle">
                    <div class="countdown-ring"></div>
                    <div class="countdown-number" id="countdown-num">5</div>
                </div>
                <button class="btn-continue" onclick="watchAdAndContinue()">
                    ‚ñ∂ ${t('continueGame')} (${currentLanguage === 'pt' ? 'An√∫ncio' : currentLanguage === 'en' ? 'Ad' : 'Anuncio'})
                </button>
                <p style="font-size: 0.9rem; color: #999; margin-top: 10px;">${waitText} ${countdownSeconds}${restartText}</p>
            `;
            overlay.style.display = 'flex';
            
            // Inicia contagem regressiva
            startCountdown();
        }
        
        function startCountdown() {
            const countdownEl = document.getElementById('countdown-num');
            if (!countdownEl) return;
            
            countdownTimer = setInterval(() => {
                countdownSeconds--;
                countdownEl.innerText = countdownSeconds;
                
                if (countdownSeconds <= 0) {
                    clearInterval(countdownTimer);
                    // Tempo esgotado - reinicia o n√≠vel
                    autoRetryLevel();
                }
            }, 1000);
        }
        
        function watchAdAndContinue() {
            // Para o contador
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            
            // Mostra an√∫ncio intersticial usando o AdManager
            AdManager.showInterstitial(() => {
                // Callback: executado ap√≥s o an√∫ncio
                restoreGameState();
            });
        }
        
        // Valida se todos os tipos de pe√ßas t√™m contagem divis√≠vel por 3
        function validateTrioRule(tiles) {
            const typeCounts = {};
            tiles.forEach(t => {
                typeCounts[t.type] = (typeCounts[t.type] || 0) + 1;
            });
            
            // Todos os tipos devem ter contagem divis√≠vel por 3
            for (let type in typeCounts) {
                if (typeCounts[type] % 3 !== 0) {
                    return false;
                }
            }
            return true;
        }

        function restoreGameState() {
            if (!gameOverState) return;
            
            // Restaura estado salvo
            tilesOnBoard = gameOverState.boardTiles;
            tilesInTray = gameOverState.trayTiles;
            
            // Remove pe√ßas da bandeja de forma inteligente para manter a regra de divisibilidade por 3
            if (tilesInTray.length > 0) {
                // Conta tipos de pe√ßas na bandeja
                const trayTypeCounts = {};
                tilesInTray.forEach(t => {
                    trayTypeCounts[t.type] = (trayTypeCounts[t.type] || 0) + 1;
                });
                
                // Estrat√©gia 1: Encontrar tipos com contagem n√£o-divis√≠vel por 3 e remover para corrigir
                const typesToFix = [];
                for (let type in trayTypeCounts) {
                    const count = trayTypeCounts[type];
                    const remainder = count % 3;
                    if (remainder !== 0) {
                        typesToFix.push({ type, removeCount: remainder });
                    }
                }
                
                // Se h√° tipos para corrigir, remove o necess√°rio
                if (typesToFix.length > 0) {
                    typesToFix.forEach(fix => {
                        for (let i = 0; i < fix.removeCount; i++) {
                            const indexToRemove = tilesInTray.findIndex(t => t.type === fix.type);
                            if (indexToRemove !== -1) {
                                tilesInTray.splice(indexToRemove, 1);
                            }
                        }
                    });
                } else {
                    // Estrat√©gia 2: Se todos j√° s√£o divis√≠veis por 3, remove um trio completo
                    // (pega o primeiro tipo e remove 3 dele)
                    const firstType = tilesInTray[0].type;
                    for (let i = 0; i < 3; i++) {
                        const indexToRemove = tilesInTray.findIndex(t => t.type === firstType);
                        if (indexToRemove !== -1) {
                            tilesInTray.splice(indexToRemove, 1);
                        }
                    }
                }
                
                // Valida√ß√£o final: Garante que todas as pe√ßas (tabuleiro + bandeja) respeitam a regra
                const allTiles = [...tilesOnBoard, ...tilesInTray];
                if (!validateTrioRule(allTiles)) {
                    console.warn('Aviso: Estado restaurado n√£o respeita regra de trio. Reiniciando n√≠vel.');
                    startLevel(currentLevel);
                    return;
                }
            }
            
            // Recria o tabuleiro
            boardEl.innerHTML = '';
            tilesOnBoard.forEach(tile => {
                const el = document.createElement('div');
                el.classList.add('tile');
                el.innerText = tile.type;
                el.style.left = tile.x + 'px';
                el.style.top = tile.y + 'px';
                el.style.zIndex = 10 + tile.z;
                if (tile.z === 0) el.style.backgroundColor = "#eee";
                el.onclick = () => handleTileClick(tile);
                boardEl.appendChild(el);
                tile.el = el;
            });
            
            checkBlockedTiles();
            updateTrayUI();
            overlay.style.display = 'none';
            gameOverState = null;
        }
        
        function autoRetryLevel() {
            // Tempo esgotado - reinicia o n√≠vel
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            gameOverState = null;
            retryLevel();
        }

        function nextLevel() {
            playClickSound();
            startLevel(currentLevel + 1);
        }

        function retryLevel() {
            playClickSound();
            // Para qualquer contador ativo
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            gameOverState = null;
            startLevel(currentLevel);
        }

        // IN√çCIO
        startLevel(1);

    </script>
</body>
</html>
